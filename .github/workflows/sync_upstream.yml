name: Sync Upstream

on:
  schedule:
    - cron: '0 12 * * *' # Run daily at 12:00 UTC
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history
      - name: Install git-filter-repo
        run: pip install git-filter-repo
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/flutter/packages.git || true
          git fetch upstream main
      - name: Debug upstream commits
        run: |
          git log upstream/main --oneline -n 10 -- packages/pigeon LICENSE README.md script .gitignore .github .ci .gitattributes analysis_options.yaml customer_testing.bat customer_testing.sh .clang-format .ci.yaml CONTRIBUTING.md
      - name: Merge upstream changes
        run: |
          git checkout main
          git merge upstream/main --allow-unrelated-histories || echo "Merge conflicts detected"
      - name: Apply git filter-repo
        run: |
          git filter-repo --path packages/golub --path LICENSE --path README.md --path script --path .gitignore --path .github --path .ci --path .gitattributes --path analysis_options.yaml --path customer_testing.bat --path customer_testing.sh --path .clang-format --path .ci.yaml --path CONTRIBUTING.md --force
      - name: Debug git status
        run: |
          git status
          git log --oneline -n 5
      - name: Create or update PR for sync
        run: |
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            EXISTING_PR=$(gh pr list --label "sync upstream" --state open --json number,headRefName --jq '.[0] | select(.number) | .number + ":" + .headRefName' || true)
            BRANCH_NAME=""
            COMMIT_MESSAGE="Sync with upstream"
            PR_TITLE="Sync Upstream"
            PR_BODY="Sync with upstream flutter/packages."
            if git status --porcelain | grep '^UU'; then
              echo "Merge conflicts detected:" >> pr_body.txt
              git status >> pr_body.txt
              PR_BODY="$PR_BODY\n\nMerge conflicts detected. Please resolve conflicts before merging.\n\n$(cat pr_body.txt)"
              COMMIT_MESSAGE="$COMMIT_MESSAGE (conflicts detected)"
              PR_TITLE="$PR_TITLE (Conflicts)"
            else
              PR_BODY="$PR_BODY\n\nNo conflicts detected."
            fi
            if [ -n "$EXISTING_PR" ]; then
              PR_NUMBER=$(echo "$EXISTING_PR" | cut -d':' -f1)
              BRANCH_NAME=$(echo "$EXISTING_PR" | cut -d':' -f2)
              echo "Updating existing PR #$PR_NUMBER on branch $BRANCH_NAME"
              git checkout "$BRANCH_NAME" || git fetch origin "$BRANCH_NAME:$BRANCH_NAME" && git checkout "$BRANCH_NAME"
              git merge upstream/main --allow-unrelated-histories || true
              git filter-repo --path packages/golub --path LICENSE --path README.md --path script --path .gitignore --path .github --path .ci --path .gitattributes --path analysis_options.yaml --path customer_testing.bat --path customer_testing.sh --path .clang-format --path .ci.yaml --path CONTRIBUTING.md --force
              git commit -m "$COMMIT_MESSAGE" || true
              git push origin "$BRANCH_NAME"
              gh pr edit "$PR_NUMBER" --title "$PR_TITLE" --body "$PR_BODY"
            else
              BRANCH_NAME="sync-upstream-$(date +%Y%m%d-%H%M%S)"
              echo "Creating new PR on branch $BRANCH_NAME"
              git checkout -b "$BRANCH_NAME"
              git commit -m "$COMMIT_MESSAGE" || true
              git push origin "$BRANCH_NAME"
              gh pr create --title "$PR_TITLE" --body "$PR_BODY" --base main --head "$BRANCH_NAME" --assignee feduke-nukem --label "sync upstream"
            fi
          else
            echo "No changes to commit. Skipping PR creation."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
